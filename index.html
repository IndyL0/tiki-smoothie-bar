<!DOCTYPE html>
<html>
<head>
    <title>Smoothie Catcher - Final Build</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü•§</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü•§</text></svg>">

    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: linear-gradient(to bottom, #005f73 0%, #0a9396 60%, #94d2bd 90%, #e9d8a6 100%); 
            font-family: 'Arial', sans-serif; 
            touch-action: none; 
        }
        
        canvas { display: block; background: transparent; }

        #statsArea { position: absolute; top: 90px; left: 20px; pointer-events: none; z-index: 5; }
        #scoreText { font-size: 28px; font-weight: bold; color: #fff; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin: 0; }
        #highScoreText { font-size: 18px; color: #ffd700; margin: 0; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        #maxComboText { font-size: 18px; color: #00f2fe; margin: 0; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        #livesDisplay { font-size: 35px; margin-top: 5px; }

        #recipeContainer { 
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%); 
            pointer-events: none; text-align: center; min-width: 300px; z-index: 5;
            background: rgba(255, 255, 255, 0.2); padding: 10px 20px; border-radius: 20px; backdrop-filter: blur(8px); 
            border: 2px solid rgba(255,255,255,0.3);
        }

        #orderTitle { font-size: 16px; color: #fff; text-transform: uppercase; font-weight: bold; text-shadow: 1px 1px 2px #000; }
        #smoothieName { font-size: 32px; color: #ffca3a; font-weight: 900; display: block; margin: 2px 0; text-shadow: 2px 2px 4px #000; }
        #ingredients { font-size: 28px; font-weight: bold; color: #fff; text-shadow: 1px 1px 2px #000; }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); color: white; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; z-index: 20;
            text-align: center;
        }

        #message { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); 
                   font-size: 40px; font-weight: bold; color: #ff4500; text-align: center; 
                   background: rgba(255,255,255,0.95); padding: 30px; border-radius: 30px; 
                   box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; z-index: 10; line-height: 1.2; }
        
        #success { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
                   font-size: 60px; color: #ffffff; font-weight: bold; display: none; text-shadow: 4px 4px #32cd32; z-index: 10;}
        
        button { padding: 20px 40px; font-size: 28px; cursor: pointer; border-radius: 15px; border: none; background: #ae2012; color: white; margin-top: 25px; font-weight: bold; transition: transform 0.1s; }
        button:hover { transform: scale(1.05); background: #d00000; }

        .instruction-box { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body>

<div id="startScreen" class="overlay">
    <h1 style="font-size: 60px; color: #ffca3a; margin-bottom: 10px;">üçπ TIKI SMOOTHIE BAR ü••</h1>
    <div class="instruction-box">
        <p style="font-size: 24px;">1. Follow the <strong>Recipe</strong> at the top.</p>
        <p style="font-size: 24px;">2. Catch <strong>fruit</strong> to earn <strong>points</strong> and <strong>Combos</strong>.</p>
        <p style="font-size: 24px;">3. Avoid <strong>Gross Items</strong> (Soap, Socks, Bugs!)</p>
        <p style="font-size: 20px; color: #00f2fe;">3 Mistakes and the Bar is Closed!</p>
    </div>
    <button id="startBtn">START SHIFT</button>
</div>

<div id="statsArea">
    <div id="scoreText">Score: 0 | Level: 1</div>
    <div id="highScoreText">Best Score: 0</div>
    <div id="maxComboText">Best Streak: 1x</div>
    <div id="livesDisplay">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
</div>

<div id="recipeContainer">
    <span id="orderTitle">üçπ Tiki Bar Order üçπ</span>
    <span id="smoothieName">Loading...</span>
    <div id="ingredients"></div>
</div>

<div id="message"></div>
<div id="success">‚ú® PERFECT! ‚ú®</div>

<div id="gameOverScreen" class="overlay" style="display: none;">
    <h1>ü•• BAR'S CLOSED!</h1>
    <p id="finalScore" style="font-size: 26px; margin-bottom: 5px;"></p>
    <div id="newRecordMsg" style="color: #ffd700; font-size: 22px; margin-bottom: 15px;"></div>
    <button id="retryBtn">Next Shift</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreDisplay = document.getElementById('scoreText');
const highScoreDisplay = document.getElementById('highScoreText');
const maxComboDisplay = document.getElementById('maxComboText');
const livesDisplay = document.getElementById('livesDisplay');
const ingredientDisplay = document.getElementById('ingredients');
const smoothieNameDisplay = document.getElementById('smoothieName');
const messageDisplay = document.getElementById('message');
const successDisplay = document.getElementById('success');
const startScreen = document.getElementById('startScreen');
const gameOverScreen = document.getElementById('gameOverScreen');
const finalScoreText = document.getElementById('finalScore');
const newRecordMsg = document.getElementById('newRecordMsg');
const startBtn = document.getElementById('startBtn');
const retryBtn = document.getElementById('retryBtn');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const goodFruits = ["üçé", "üçå", "üçá", "üçì", "üçç", "ü•≠"];
const fruitColors = { "üçé": "#ff0000", "üçå": "#ffe135", "üçá": "#6f2da8", "üçì": "#ff43a4", "üçç": "#f3e11b", "ü•≠": "#ff8243" };
const fruitNames = { "üçé": "Apple", "üçå": "Banana", "üçá": "Grape", "üçì": "Berry", "üçç": "Pine", "ü•≠": "Mango" };
const grossItems = ["üß¶", "üßº", "üëü", "üêü", "ü™≤", "üîã"]; 
const failMap = { "üß¶": "Sock Sludge", "üßº": "Soap Suds", "üëü": "Shoe Shake", "üêü": "Fishy Fizz", "ü™≤": "Bug Brew", "üîã": "Battery Blast", "üçé": "Wrong Apple", "üçå": "Bad Banana", "üçá": "Gross Grape", "üçì": "Silly Berry", "üçç": "Painful Pine", "ü•≠": "Messy Mango" };

const BLENDER_SIZE = 140;
const FRUIT_SIZE = 80;
const NUM_LANES = 5;
const laneWidth = canvas.width / NUM_LANES;

let score, level, gameSpeedMultiplier, lives, currentRecipe, currentSmoothieName, fallingItems, particles, isPaused, isStarted = false;
let combo = 1;
let highScore = localStorage.getItem('smoothieHighScore') || 0;
let bestCombo = localStorage.getItem('smoothieMaxCombo') || 1;

let blender = { x: canvas.width / 2, y: canvas.height - 180, width: BLENDER_SIZE, height: BLENDER_SIZE, rotation: 0, shakeAmount: 0 };
let audioCtx = null;

function ensureAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playWhizSound() {
    ensureAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(120 + (combo * 10), audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(900 + (combo * 20), audioCtx.currentTime + 0.15);
    gain.gain.setValueAtTime(0.12, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + 0.2);
}

function playBuzzerSound() {
    ensureAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'square';
    osc.frequency.setValueAtTime(150, audioCtx.currentTime);
    osc.frequency.setValueAtTime(110, audioCtx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.03, audioCtx.currentTime);
    gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + 0.2);
}

function playGameOverSound() {
    ensureAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'square';
    osc.frequency.setValueAtTime(300, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.8);
    gain.gain.setValueAtTime(0.04, audioCtx.currentTime);
    gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.8);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + 0.8);
}

function initVariables() {
    score = 0; level = 1; gameSpeedMultiplier = 1.0; lives = 3; combo = 1;
    fallingItems = []; particles = []; isPaused = false;
    gameOverScreen.style.display = "none";
    startNewRecipe();
    updateUI();
}

function startGame() {
    ensureAudio();
    isStarted = true;
    startScreen.style.display = "none";
    initVariables();
}

function startNewRecipe() {
    currentRecipe = [];
    let maxTypes = level <= 2 ? 1 : (level <= 5 ? 2 : 3);
    const num = Math.floor(Math.random() * maxTypes) + 1;
    const shuffled = [...goodFruits].sort(() => 0.5 - Math.random());
    for (let i = 0; i < num; i++) {
        const amt = level > 6 ? Math.floor(Math.random() * 3) + 1 : Math.floor(Math.random() * 2) + 1;
        currentRecipe.push({ type: shuffled[i], needed: amt });
    }
    const names = currentRecipe.map(item => fruitNames[item.type]);
    const suffixes = ["Zest", "Breeze", "Squeeze", "Wave", "Splash", "Cooler"];
    const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
    if (names.length === 1) currentSmoothieName = `${names[0]} ${suffix}`;
    else if (names.length === 2) currentSmoothieName = `${names[0]} & ${names[1]}`;
    else currentSmoothieName = `Tropical ${suffix}`;
}

function updateUI() {
    scoreDisplay.innerText = `Score: ${score} | Level: ${level}`;
    highScoreDisplay.innerText = `Best Score: ${highScore}`;
    maxComboDisplay.innerText = `Best Streak: ${bestCombo}x`;
    livesDisplay.innerText = "‚ù§Ô∏è".repeat(Math.max(0, lives));
    smoothieNameDisplay.innerText = currentSmoothieName;
    let html = "";
    currentRecipe.forEach(item => {
        const style = item.needed === 0 ? "text-decoration: line-through; opacity: 0.1;" : "";
        html += `<span style="${style}">${item.needed}x ${item.type}</span> `;
    });
    ingredientDisplay.innerHTML = html;
}

function handleCatch(item) {
    const recipeItem = currentRecipe.find(r => r.type === item.type && r.needed > 0);
    if (recipeItem) {
        recipeItem.needed--;
        score += (10 * combo);
        combo++;
        if (combo > bestCombo) {
            bestCombo = combo;
            localStorage.setItem('smoothieMaxCombo', bestCombo);
        }
        for (let i = 0; i < 12; i++) {
            particles.push({
                x: item.x + FRUIT_SIZE/2, y: item.y + FRUIT_SIZE/2,
                vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10 - 2,
                radius: Math.random() * 6 + 2, color: fruitColors[item.type] || "#fff", alpha: 1
            });
        }
        playWhizSound();
        blender.rotation = (Math.random() - 0.5) * 0.4;
        setTimeout(() => { blender.rotation = 0; }, 100);
        if (currentRecipe.every(r => r.needed === 0)) {
            successDisplay.innerText = currentRecipe.length === 1 ? "‚ú® PERFECT! ‚ú®" : "‚ú® PERFECT MIX! ‚ú®";
            score += 100; level += 1; gameSpeedMultiplier += 0.10;
            successDisplay.style.display = "block";
            setTimeout(() => { successDisplay.style.display = "none"; }, 1200);
            startNewRecipe();
        }
    } else {
        lives--;
        combo = 1;
        playBuzzerSound();
        blender.shakeAmount = 15; 
        messageDisplay.innerHTML = `<span style="font-size:24px">ü§¢ YUCK!</span><br>${failMap[item.type] || "Mistake!"}`;
        messageDisplay.style.display = "block";
        setTimeout(() => { messageDisplay.style.display = "none"; }, 1800);
        if (lives <= 0) triggerGameOver();
    }
    updateUI();
}

function triggerGameOver() {
    isPaused = true;
    playGameOverSound();
    finalScoreText.innerText = `Shift over! Final Score: ${score}`;
    let recordText = "";
    if (score > highScore) {
        highScore = score;
        localStorage.setItem('smoothieHighScore', highScore);
        recordText += "üèÜ NEW HIGH SCORE! ";
    }
    newRecordMsg.innerText = recordText;
    gameOverScreen.style.display = "flex";
}

window.addEventListener('mousemove', (e) => { blender.x = e.clientX - blender.width / 2; });
window.addEventListener('touchmove', (e) => { e.preventDefault(); blender.x = e.touches[0].clientX - blender.width / 2; }, {passive: false});

startBtn.addEventListener('click', startGame);
retryBtn.addEventListener('click', initVariables);

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // BAR
    ctx.fillStyle = "#bb3e03"; ctx.fillRect(0, canvas.height - 110, canvas.width, 110);
    ctx.fillStyle = "#9b2226"; ctx.fillRect(0, canvas.height - 110, canvas.width, 15);

    // CEILING
    ctx.fillStyle = "#ca6702"; ctx.fillRect(0, 0, canvas.width, 80);
    ctx.strokeStyle = "#9b2226";
    for(let i=0; i<canvas.width; i+=15) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,80); ctx.stroke(); }

    if (isStarted && !isPaused) {
        // PARTICLES
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.alpha -= 0.02;
            if (p.alpha <= 0) particles.splice(i, 1);
            else { ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2); ctx.fill(); }
        }
        ctx.globalAlpha = 1; 

        // ITEMS
        for (let i = fallingItems.length - 1; i >= 0; i--) {
            let item = fallingItems[i]; item.y += item.speed;
            ctx.font = `${FRUIT_SIZE}px Arial`; ctx.fillText(item.type, item.x, item.y);
            if (item.y > blender.y && item.y < blender.y + blender.height &&
                item.x + FRUIT_SIZE > blender.x && item.x < blender.x + blender.width) {
                handleCatch(item); fallingItems.splice(i, 1);
            } else if (item.y > canvas.height) { fallingItems.splice(i, 1); }
        }

        // CUP & COMBO
        let currentX = blender.x; let currentY = blender.y;
        if (blender.shakeAmount > 0) {
            currentX += (Math.random() - 0.5) * blender.shakeAmount;
            currentY += (Math.random() - 0.5) * blender.shakeAmount;
            blender.shakeAmount *= 0.9;
            if (blender.shakeAmount < 0.5) blender.shakeAmount = 0;
        }

        ctx.save();
        ctx.translate(currentX + blender.width / 2, currentY + blender.height / 2);
        ctx.rotate(blender.rotation);
        ctx.font = `${BLENDER_SIZE}px Arial`;
        ctx.fillText("ü•§", -blender.width / 2, 40);
        if (combo > 1) {
            ctx.fillStyle = "#00f2fe"; ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
            let fSize = 20 + Math.min(combo * 2, 40);
            ctx.font = `bold ${fSize}px Arial`;
            ctx.fillText(`${combo}x`, 40, -20); ctx.strokeText(`${combo}x`, 40, -20);
        }
        ctx.restore();
    }
    requestAnimationFrame(gameLoop);
}

setInterval(() => { if(isStarted && !isPaused) { 
    const lane = Math.floor(Math.random() * NUM_LANES);
    const xPos = (lane * laneWidth) + (laneWidth / 2) - (FRUIT_SIZE / 2);
    let type; const roll = Math.random();
    if (roll < 0.20) type = grossItems[Math.floor(Math.random() * grossItems.length)];
    else if (roll < 0.85) {
        const stillNeeded = currentRecipe.filter(r => r.needed > 0);
        type = stillNeeded.length > 0 ? stillNeeded[Math.floor(Math.random() * stillNeeded.length)].type : goodFruits[0];
    } else type = goodFruits[Math.floor(Math.random() * goodFruits.length)];
    fallingItems.push({ x: xPos, y: -100, type: type, speed: (4 + Math.random() * 2) * gameSpeedMultiplier });
}}, 1000);

gameLoop();
</script>
</body>
</html>
